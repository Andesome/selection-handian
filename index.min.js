!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).SelectionHandian=e()}(this,function(){"use strict";function o(e,t){var n,o=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)),o}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach(function(t){l(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function s(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function l(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var a={MAX_TIME_OUT:5e3,scroller:void 0,container:document.body,el:document.body,popup:null,offsetX:2,offsetY:18,onEnd:function(){}},r={mobile:{START:"touchstart",END:"touchend"},pc:{START:"mousedown",END:"mouseup"}},t=function(){function n(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),l(this,"utils",{hasMobileUA:function(){var t=window.navigator.userAgent;return/iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g.test(t)},isMobile:function(){return window.screen.width<767&&this.hasMobileUA()},getRelativePos:function(t){return"mobile"===e.platform?{x:t.changedTouches[0].clientX||0,y:t.changedTouches[0].clientY||0}:{x:t.clientX||0,y:t.clientY||0}}}),l(this,"trimText",function(t){t=String(t).trim().replace(/([。，！～【】\(\)（）])|(\d)|(\s*)/gi,"").replace(/[a-zA-Z]/g,"");return/[^\u0000-\u00FF]/.test(t)?t:""}),l(this,"injectStyles",function(t){var e=document.createElement("style");return e.type="text/css",e.innerHTML="\n      body * {\n        -webkit-touch-callout: none;\n      }\n      .ly-selection-popup-button {\n        will-change: transform, opacity;\n        transition: transform 350ms cubic-bezier(0.4, 0, 0.2, 1) 0ms, opacity 500ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;\n      }\n      .ly-selection-popup-cotainer .handian-loading {\n        opacity: 1;\n        will-change: transform, opacity;\n      }\n      .ly-selection-popup-cotainer .handian-loading.hide {\n          transition: opacity,transform  0.25s cubic-bezier(0, 0, 0.2, 1) 0s;\n      }\n      .ly-selection-popup-cotainer.mobile .handian-loading.hide {\n          opacity: 0;\n          visibility: hidden;\n      }\n      .ly-selection-popup-cotainer.pc .handian-loading.hide {\n        transform: translateY(-100%);\n      }\n    ",document.head.appendChild(e),e}),l(this,"getPopup",function(){return e.popup}),l(this,"getPopupVisible",function(){return"none"!==window.getComputedStyle(e.popup).display}),l(this,"getLoadingVisible",function(){var t=document.querySelector("#handian-loading");return t&&0<t.clientHeight}),l(this,"showButton",function(){e.button&&(e.button.style.opacity=1,e.button.style.pointerEvents="auto")}),l(this,"hideButton",function(){e.button&&(e.button.style.opacity=0,e.button.style.pointerEvents="none")}),l(this,"showPopup",function(){e.popup&&(e.options.container.style.overflow="hidden",e.popup.style.display="block",e.isMobile&&(e.mask.style.opacity=1,e.mask.style.visibility="visible",e.mask.style.zIndex=1200))}),l(this,"hidePopup",function(){e.popup&&(e.options.container.style.overflow="auto",e.isMobile?e.popup.style.transform="translateY(100%)":e.popup.style.display="none"),e.isMobile&&(e.mask.style.opacity=0,e.mask.style.visibility="hidden",e.mask.style.zIndex=-1)}),l(this,"hideAll",function(){e.hideButton(),e.hidePopup()}),this.options=i(i({},a),t),this._init()}var t,e,o;return t=n,(e=[{key:"_init",value:function(){this.isMobile=this.utils.isMobile(),this.platform=this.isMobile?"mobile":"pc",this.isMobile&&this._createMask(),this._createPopup(),this.injectStyles(),this._bindEvents(),this._prefetchHanDian()}},{key:"_bindEvents",value:function(){var n=this,t=this.options;t.container;var e=t.el,o=t.onEnd;window.removeEventListener(r[this.platform].START,this.hideAll),e.addEventListener("contextmenu",function(t){return t.preventDefault()}),e.addEventListener(r[this.platform].END,function(t){var e=window.getSelection();"Range"===e.type&&(e=e.toString(),(e=n.trimText(e))&&(n._createButton(event,e),o(t,e,n),window.addEventListener(r[n.platform].START,n.hideAll)))})}},{key:"_prefetchHanDian",value:function(){setTimeout(function(){var t=document.createElement("iframe");t.src="//www.zdic.net",t.width=0,t.height=0,t.style.width="0px",t.style.height="0px",t.style.overflow="hidden",t.style.opacity="0",t.frameBorder="0",t.sandbox="allow-same-origin allow-forms",t.seamless="seamless",document.body.appendChild(t)},1e3)}},{key:"_createButton",value:function(t,e){var n=this,o=document.querySelector(".ly-selection-popup-button"),i=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,t=this.utils.getRelativePos(t),s=t.x,l=t.y+i;return o||((o=document.createElement("div")).setAttribute("class","ly-selection-popup-button"),o.style.position="absolute",o.style.display="block",o.style.left=0,o.style.top=0,o.style.width="32px",o.style.minHeight="32px",o.style.borderRadius="3px",o.style.backgroundColor="#f5f5f5",o.style.fontWeigh=500,o.style.color="#9d6a51",o.style.cursor="pointer",o.style.zIndex="1200",o.style.textAlign="center",o.style.lineHeight="32px",o.style.fontSize="16px",o.style.userSelect="none",o.innerText="典",o.title="查汉典",o.addEventListener(r[this.platform].START,function(t){return t.stopPropagation()}),o.addEventListener(r[this.platform].END,function(t){return t.stopPropagation()}),document.body.appendChild(o),this.button=o),this.showButton(),o.onclick=function(t){t.stopPropagation(),n.hideButton();t=n._createHanDian(e);n.popup.appendChild(t),n.popup.style.left="".concat(n.isMobile?0:s,"px"),n.isMobile?(n.popup.style.left="0px",n.popup.style.bottom="0px",n.popup.style.transform="translateY(100%)"):n.popup.style.top="".concat(n.isMobile?-window.innerHeight:l,"px"),n.showPopup();t=n.calcPosition({x:s+n.options.offsetX,y:l+n.options.offsetY},n.popup);n.callPosition(n.popup,t)},o.style.transform="translate(".concat(s,"px, ").concat(l+this.options.offsetY,"px)"),o}},{key:"_createMask",value:function(){var t=document.createElement("div");t.setAttribute("class","ly-selection-popup-mask ".concat(this.platform)),t.style.position="fixed",t.style.visibility="hidden",t.style.left=0,t.style.top=0,t.style.width="100%",t.style.height="100%",t.style.zIndex=-1,t.style.backgroundColor="rgba(0,0,0,0.5)",t.style["-webkit-tap-highlight-color"]="transparent",t.style.opacity=0,t.style.transition="opacity 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms",this.options.container.appendChild(t),this.mask=t}},{key:"_createPopup",value:function(){var t=document.createElement("div");t.setAttribute("class","ly-selection-popup-cotainer ".concat(this.platform)),t.style.position=this.isMobile?"fixed":"absolute",t.style.display="none",t.style.zIndex="1201",t.style.left=0,t.style.top=this.isMobile?"":"0",t.style.minWidth=this.isMobile?"100vw":"375px",t.style.minHeight=this.isMobile?"60vh":"375px",t.style.backgroundColor="#fff",t.style.borderRadius="2px",t.style.boxShadow="rgb(0 0 0 / 8%) 1px 2px 13px 0px",t.style.overflow=this.isMobile?"auto":"hidden";var e=document.createElement("p");return e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.width="100%",e.style.height=this.isMobile?"100%":"20px",e.style.zIndex="99",e.style.textAlign="center",e.style.fontSize="12px",e.style.backgroundColor="rgba(248, 249, 251, 0.8)",e.style.color="#555",e.style.margin="0",e.style.overflow="hidden",e.setAttribute("class","handian-loading hide"),e.innerHTML="加載結果中，請稍候……",e.id="handian-loading",t.appendChild(e),document.body.appendChild(t),this.popup=t}},{key:"_createHanDian",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",n=document.getElementById("handian_content");n&&this.popup.removeChild(n),clearTimeout(this._timer);n=document.createElement("iframe");return n.frameBorder="0",n.src="https://www.zdic.net/hans/".concat(e),n.sandbox="allow-same-origin allow-forms",n.seamless="seamless",n.id="handian_content",n.width=this.isMobile?window.innerWidth:"375",n.height=this.isMobile?.6*window.innerHeight:"400",console.log("加载汉典",Date.now()),this.showLoading(),n.addEventListener("load",function(){console.log("汉典加载好了",Date.now()),t.hideLoading()}),this.options.MAX_TIME_OUT&&(this._timer=setTimeout(function(){t.getLoadingVisible()&&(console.warn("汉典加载超过".concat(t.options.MAX_TIME_OUT,"ms")),t.hideLoading())},this.options.MAX_TIME_OUT)),n}},{key:"calcPosition",value:function(t,e){if(t&&e){var n=t.x,o=t.y,i=Math.max(window.innerWidth,document.body.scrollWidth),t=Math.max(window.innerHeight,document.body.scrollHeight),e=e.getBoundingClientRect();return{left:Math.min(n,i-e.width),top:Math.min(o,t-e.height)}}}},{key:"callPosition",value:function(t,e){var n;e&&t&&(t.style.transition="all 0.35s cubic-bezier(0, 0, 0.2, 1) 0s",this.isMobile?t.style.transform="translateY(0px)":(t.style.left="".concat(e.left,"px"),t.style.top="".concat(e.top,"px"),n=e.top+t.clientHeight,e=this.options.scroller?this.options.scroller.scrollTop:Math.max(document.documentElement.scrollTop,document.body.scrollTop),t=window.innerHeight+e,0<(t=Math.max(0,n-t))&&(t={top:e+t,behavior:"smooth"},this.options.scroller?this.options.scroller.scrollTo(t):(document.documentElement.scrollTo(t),document.body.scrollTo(t)))))}},{key:"showLoading",value:function(){var t=document.getElementById("handian-loading");t&&t.classList.remove("hide")}},{key:"hideLoading",value:function(){var t=document.getElementById("handian-loading");t&&t.classList.add("handian-loading","hide")}}])&&s(t.prototype,e),o&&s(t,o),n}();return new t({onEnd:function(t,e,n){console.log("self:",n.platform),Array.isArray(window.dataLayer)&&window.dataLayer.push(Object.assign({event:"dianClick",selection_text:e,platform:n.platform}))}}),t});
